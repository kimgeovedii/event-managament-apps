generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                @id @default(uuid())
  name                 String
  email                String                @unique
  password             String
  referralCode         String                @unique
  points               Int                   @default(0)
  role                 Role                  @default(CUSTOMER)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  organizationsManaged Organization[]        @relation("OrgCreator")
  organizationTeams    OrganizationTeam[]
  referralsSent        ReferralTransaction[] @relation("ReferralFrom")
  referralsReceived    ReferralTransaction[] @relation("ReferralTo")
  ticketsCreated       Ticket[]
  transactions         Transaction[]
  userPoints           UserPoint[]

  @@index([email])
  @@index([referralCode])
}

model Organization {
  id        String             @id @default(uuid())
  name      String
  address   String?
  creatorId String
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  creator   User               @relation("OrgCreator", fields: [creatorId], references: [id])
  teams     OrganizationTeam[]
  tickets   Ticket[]

  @@index([creatorId])
}

model OrganizationTeam {
  id             String       @id @default(uuid())
  userId         String
  organizationId String
  role           OrgRole      @default(MEMBER)
  field          String?
  user           User         @relation(fields: [userId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([userId])
  @@index([organizationId])
}

model Category {
  id      String   @id @default(uuid())
  name    String   @unique
  status  Boolean  @default(true)
  tickets Ticket[]
}

model Ticket {
  id             String            @id @default(uuid())
  title          String
  description    String?
  price          Float             @default(0)
  startDate      DateTime
  endDate        DateTime
  organizationId String
  organization   Organization      @relation(fields: [organizationId], references: [id])
  categoryId     String
  category       Category          @relation(fields: [categoryId], references: [id])
  createdById    String
  createdBy      User              @relation(fields: [createdById], references: [id])
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  allotments     Allotment?
  promotions     Promotion[]
  items          TransactionItem[]

  @@index([organizationId])
  @@index([categoryId])
  @@index([createdById])
  @@index([startDate, endDate])
}

model Allotment {
  id             String   @id @default(uuid())
  ticketId       String   @unique
  ticket         Ticket   @relation(fields: [ticketId], references: [id])
  totalQuota     Int
  remainingQuota Int
  updatedAt      DateTime @updatedAt

  @@index([ticketId])
}

model ReferralTransaction {
  id         String   @id @default(uuid())
  fromUserId String
  toUserId   String
  date       DateTime @default(now())
  amount     Float
  expiredAt  DateTime
  fromUser   User     @relation("ReferralFrom", fields: [fromUserId], references: [id])
  toUser     User     @relation("ReferralTo", fields: [toUserId], references: [id])

  @@index([fromUserId])
  @@index([toUserId])
}

model UserPoint {
  id             String   @id @default(uuid())
  userId         String
  remainingPoint Int
  user           User     @relation(fields: [userId], references: [id])
  createdAt      DateTime @default(now())
  expiredAt      DateTime

  @@index([userId])
}

model Voucher {
  id           String        @id @default(uuid())
  type         VoucherType   @default(PROMOTION)
  name         String
  code         String        @unique
  amount       Float
  maxClaim     Int?
  startDate    DateTime
  endDate      DateTime
  promotions   Promotion[]
  transactions Transaction[]

  @@index([code])
}

model Promotion {
  id          String   @id @default(uuid())
  name        String
  description String?
  ticketId    String
  ticket      Ticket   @relation(fields: [ticketId], references: [id])
  voucherId   String
  voucher     Voucher  @relation(fields: [voucherId], references: [id])
  startDate   DateTime
  endDate     DateTime

  @@index([ticketId])
  @@index([voucherId])
}

model Transaction {
  id          String            @id @default(uuid())
  invoice     String            @unique
  date        DateTime          @default(now())
  totalPrice  Float
  pointsUsed  Int               @default(0)
  customerId  String
  customer    User              @relation(fields: [customerId], references: [id])
  voucherId   String?
  voucher     Voucher?          @relation(fields: [voucherId], references: [id])
  items       TransactionItem[]

  @@index([customerId])
  @@index([voucherId])
  @@index([date])
}

model TransactionItem {
  id            String      @id @default(uuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  ticketId      String
  ticket        Ticket      @relation(fields: [ticketId], references: [id])
  qty           Int
  subTotal      Float
  review        Review?

  @@index([transactionId])
  @@index([ticketId])
}

model Review {
  id                String          @id @default(uuid())
  rating            Int
  feedback          String?
  transactionItemId String          @unique
  transactionItem   TransactionItem @relation(fields: [transactionItemId], references: [id])
  createdAt         DateTime        @default(now())

  @@index([transactionItemId])
}

enum Role {
  CUSTOMER
  ORGANIZER
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum VoucherType {
  REFERRAL
  PROMOTION
}
