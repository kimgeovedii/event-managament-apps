generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(uuid())
  name         String
  email        String     @unique
  password     String
  referralCode String     @unique @map("referral_code")
  avatarUrl    String?    @map("avatar_url")
  isVerified   Boolean    @default(false) @map("is_verified")
  // roles via UserRole join table
  roles        UserRole[]
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  organizer         Organizer? // 1 user can own 1 organizer profile (optional)
  organizerTeams    OrganizerTeam[]
  referralsSent     Referral[]      @relation("ReferralFrom")
  referralsReceived Referral[]      @relation("ReferralTo")
  points            Point[]
  coupons           UserCoupon[]
  transactions      Transaction[]
  reviews           Review[]

  @@map("users")
}

model Organizer {
  id          String   @id @default(uuid())
  ownerId     String   @unique @map("owner_id")
  name        String
  description String?  @db.Text
  logoUrl     String?  @map("logo_url")
  isVerified  Boolean  @default(false) @map("is_verified")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  owner      User            @relation(fields: [ownerId], references: [id])
  teams      OrganizerTeam[]
  events     Event[]
  promotions Promotion[]

  @@map("organizers")
}

model OrganizerTeam {
  id          String   @id @default(uuid())
  organizerId String   @map("organizer_id")
  userId      String   @map("user_id")
  role        OrgRole  @default(MEMBER)
  createdAt   DateTime @default(now()) @map("created_at")

  organizer Organizer @relation(fields: [organizerId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@map("organizer_teams")
}

model Referral {
  id             String   @id @default(uuid())
  referrerId     String   @map("referrer_id")
  referredUserId String   @map("referred_user_id")
  createdAt      DateTime @default(now()) @map("created_at")

  referrer     User @relation("ReferralFrom", fields: [referrerId], references: [id])
  referredUser User @relation("ReferralTo", fields: [referredUserId], references: [id])

  @@map("referrals")
}

model Point {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  amount          Int
  remainingAmount Int       @default(0) @map("remaining_amount")
  type            PointType
  expiresAt       DateTime  @map("expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("points")
}

model UserCoupon {
  id                 String   @id @default(uuid())
  userId             String   @map("user_id")
  code               String   @unique
  discountPercentage Decimal  @default(10) @map("discount_percentage")
  expiresAt          DateTime @map("expires_at")
  isUsed             Boolean  @default(false) @map("is_used")
  createdAt          DateTime @default(now()) @map("created_at")

  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]

  @@map("user_coupons")
}

model Event {
  id          String   @id @default(uuid())
  organizerId String   @map("organizer_id")
  categoryId  String   @map("category_id")
  name        String
  description String?  @db.Text
  location    String
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  isPaid      Boolean  @default(false) @map("is_paid")
  imageUrl    String?  @map("image_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  organizer    Organizer        @relation(fields: [organizerId], references: [id])
  category     Category         @relation(fields: [categoryId], references: [id])
  ticketTypes  TicketType[]
  promotions   PromotionEvent[]
  transactions Transaction[]
  reviews      Review[]

  @@map("events")
}

model Category {
  id     String  @id @default(uuid())
  name   String  @unique
  events Event[]

  @@map("categories")
}

model TicketType {
  id          String   @id @default(uuid())
  eventId     String   @map("event_id")
  name        String
  price       Decimal
  quota       Int
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  event            Event             @relation(fields: [eventId], references: [id])
  transactionItems TransactionItem[]

  @@map("ticket_types")
}

model Promotion {
  id                 String   @id @default(uuid())
  organizerId        String   @map("organizer_id")
  name               String
  code               String   @unique
  discountAmount     Decimal? @map("discount_amount")
  discountPercentage Decimal? @map("discount_percentage")
  maxUsage           Int?     @map("max_usage")
  startDate          DateTime @map("start_date")
  endDate            DateTime @map("end_date")
  createdAt          DateTime @default(now()) @map("created_at")

  organizer    Organizer        @relation(fields: [organizerId], references: [id])
  events       PromotionEvent[]
  transactions Transaction[]

  @@map("promotions")
}

model PromotionEvent {
  promotionId String   @map("promotion_id")
  eventId     String   @map("event_id")
  createdAt   DateTime @default(now()) @map("created_at")

  promotion Promotion @relation(fields: [promotionId], references: [id])
  event     Event     @relation(fields: [eventId], references: [id])

  @@id([promotionId, eventId])
  @@map("promotion_events")
}

model Transaction {
  id                 String            @id @default(uuid())
  invoice            String            @unique
  userId             String            @map("user_id")
  eventId            String            @map("event_id")
  totalOriginalPrice Decimal           @map("total_original_price")
  totalFinalPrice    Decimal           @map("total_final_price")
  pointsUsed         Int               @default(0) @map("points_used")
  userCouponId       String?           @map("user_coupon_id")
  promotionId        String?           @map("promotion_id")
  status             TransactionStatus @default(PENDING)
  paymentMethod      String            @map("payment_method")
  transactionDate    DateTime          @default(now()) @map("transaction_date")

  user       User              @relation(fields: [userId], references: [id])
  event      Event             @relation(fields: [eventId], references: [id])
  userCoupon UserCoupon?       @relation(fields: [userCouponId], references: [id])
  promotion  Promotion?        @relation(fields: [promotionId], references: [id])
  items      TransactionItem[]

  @@map("transactions")
}

model TransactionItem {
  id            String  @id @default(uuid())
  transactionId String  @map("transaction_id")
  ticketTypeId  String  @map("ticket_type_id")
  quantity      Int
  pricePerUnit  Decimal @map("price_per_unit")
  totalPrice    Decimal @map("total_price")

  transaction Transaction @relation(fields: [transactionId], references: [id])
  ticketType  TicketType  @relation(fields: [ticketTypeId], references: [id])

  @@map("transaction_items")
}

model Review {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  eventId   String   @map("event_id")
  rating    Int
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  @@map("reviews")
}

model UserRole {
  id     String @id @default(uuid())
  userId String @map("user_id")
  role   Role

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, role])
  @@map("user_roles")
}

// Enums
enum Role {
  CUSTOMER
  ORGANIZER
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum PointType {
  EARN_REFERRAL
  USE_DISCOUNT
}

enum TransactionStatus {
  PENDING
  PAID
  CANCELED
  REFUNDED
}
